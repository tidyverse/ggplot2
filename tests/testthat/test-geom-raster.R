context("geom-raster")


# Visual tests ------------------------------------------------------------

test_that("geom_raster draws correctly", {
  set.seed(1)

  # 3 x 2 ----------------------------------------------------------------------
  df <- data.frame(x = rep(c(-1, 1), each = 3), y = rep(-1:1, 2), z = 1:6)

  vdiffr::expect_doppelganger(
    ggplot(df, aes(x, y, fill = z)) + geom_raster() + geom_point(colour = "red"),
    "3-2"
  )
  vdiffr::expect_doppelganger(
    ggplot(df, aes(x, y, fill = z)) + geom_raster() + geom_point(colour = "red") +
      xlim(-2, 2) + ylim(-2, 2),
    "3-2_set_limits"
  )
  vdiffr::expect_doppelganger(
    ggplot(df, aes(x, y, fill = z)) + geom_raster(hjust = 0, vjust = 0) +
      geom_point(colour = "red"),
    "3-2_just-0_0"
  )

  # 1 x 3 ----------------------------------------------------------------------
  df <- data.frame(x = -1:1, y = 0, z = 1:3)

  vdiffr::expect_doppelganger(
    ggplot(df, aes(x, y, fill = z)) + geom_raster() + geom_point(colour = "red"),
    "1-3"
  )
  vdiffr::expect_doppelganger(
    ggplot(df, aes(x, y, fill = z)) + geom_raster() + geom_point(colour = "red") +
      xlim(-2, 2) + ylim(-2, 2),
    "1-3_set_limits"
  )
  vdiffr::expect_doppelganger(
    ggplot(df, aes(x, y, fill = z)) + geom_raster(hjust = 0, vjust = 0) +
      geom_point(colour = "red"),
    "1-3_just-0_0"
  )

  # 3 x 1 ----------------------------------------------------------------------

  df <- data.frame(x = 0, y = -1:1, z = 1:3)
  vdiffr::expect_doppelganger(
    ggplot(df, aes(x, y, fill = z)) + geom_raster() + geom_point(colour = "red"),
    "3-1"
  )
  vdiffr::expect_doppelganger(
    ggplot(df, aes(x, y, fill = z)) + geom_raster() + geom_point(colour = "red") +
      xlim(-2, 2) + ylim(-2, 2),
    "3-1_set_limits"
  )
  vdiffr::expect_doppelganger(
    ggplot(df, aes(x, y, fill = z)) + geom_raster(hjust = 0, vjust = 0) +
      geom_point(colour = "red"),
    "3-1_just-0_0"
  )

  # Categorical fill, irregular swatches ---------------------------------------

  df <- expand.grid(x = 1:10, y = 1:10)
  df$col <- (df$x + df$y) %% 2
  df$col[df$x == 5 & df$col == 1] <- NA
  df$col[df$y == 5 & df$col == 0] <- NA
  vdiffr::expect_doppelganger(
    qplot(x, y, data = df, fill = factor(col), geom = "raster"),
    "irregular_categorical"
  )
})
